version: '3.8'

services:
  create-kafka-topic:
    image: confluentinc/cp-kafka:6.2.0
    container_name: create-kafka-topic
    depends_on:
      kafka:
        condition: service_healthy
    command: >
      sh -c "
      echo 'Waiting for Kafka to be ready...';
      until kafka-topics --bootstrap-server kafka:9092 --list; do sleep 1; done;
      echo 'Creating topic egyptkingcrash_events...';
      kafka-topics --create --topic egyptkingcrash_events 
        --bootstrap-server kafka:9092 
        --partitions 3 
        --replication-factor 1;
      echo 'Topic created successfully'"
    networks:
      - app-network

  migrate:
    build: .
    command: sh -c "./wait-for-it.sh db:5432 -- migrate -database $$DB_URL -path migrations -verbose up"
    environment:
      DB_URL: "postgres://egyptkingcrash:5kj0YmV5FKKpU9D50B7yH5A@db:5432/egyptkingcrash?sslmode=disable"
    volumes:
      - ./migrations:/app/migrations
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy

  app:
    build: .
    container_name: egyptkingcrash-app
    ports:
      - "8000:8000"
    command: sh -c "
      ./wait-for-it.sh db:5432 -- 
      ./wait-for-it.sh kafka:9092 -- 
      sleep 5;
      echo '=== ENVIRONMENT VARIABLES ===';
      printenv | grep KAFKA;
      echo '=== STARTING APPLICATION ===';
      ./egyptkingcrash"
    environment:
      # Application Configuration
      DB_URL: "postgres://egyptkingcrash:5kj0YmV5FKKpU9D50B7yH5A@db:5432/egyptkingcrash?sslmode=disable"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8000"
      JWT_SECRET: "tokensecrethere"
      DB_CONNECT_RETRIES: "10"
      DB_CONNECT_TIMEOUT: "5s"
      
      # Kafka Configuration
      KAFKA_TOPIC: "egyptkingcrash_events"
      KAFKA__TOPIC: "egyptkingcrash_events"
      KAFKA_BROKERS: "kafka:9092"
      KAFKA__BROKERS: "kafka:9092"
      KAFKA__SECURITY_PROTOCOL: "PLAINTEXT"
      KAFKA__ACKS: "all"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      
      # Redis Configuration
      REDIS__ADDR: "redis:6379"
      REDIS__PASSWORD: ""
      REDIS__DB: "0"
      REDIS__KEY_PREFIX: "egyptkingcrash:"
      REDIS__TTL: "5m"
      REDIS__ATTEMPTS: "3"
      
      # Pisi Configuration
      PISI__BASE_URL: "http://pisi-service:8080"
      PISI__PASSWORD: "pisi_password"
      PISI__VASPID: "pisi_vaspid"
      PISI__TIMEOUT: "10s"
      PISI__RETRY_COUNT: "3"
      PISI__RETRY_DELAY: "5s"
      PISI__SENDER_ID: "egyptkingcrash"
    volumes:
      - ./internal/constant/query/schemas:/app/internal/constant/query/schemas
    networks:
      - app-network
    depends_on:
      create-kafka-topic:
        condition: service_completed_successfully
      migrate:
        condition: service_completed_successfully
      kafka:
        condition: service_healthy
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  db:
    image: postgres:13
    container_name: egyptkingcrash-db
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: "egyptkingcrash"
      POSTGRES_PASSWORD: "5kj0YmV5FKKpU9D50B7yH5A"
      POSTGRES_DB: "egyptkingcrash"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U egyptkingcrash -d egyptkingcrash"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - app-network

  redis:
    image: redis:6.2
    container_name: redis
    ports:
      - "63790:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - redis_data:/data
    networks:
      - app-network

  zookeeper:
    image: zookeeper:3.8.1
    container_name: zookeeper
    hostname: zookeeper
    ports:
      - "22181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=0.0.0.0:2888:3888;2181
      ZOO_4LW_COMMANDS_WHITELIST: "mntr,ruok,conf,cons"
      ZOO_MAX_CLIENT_CNXNS: 1000
    volumes:
      - zk_data:/data
      - zk_logs:/datalog
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc localhost 2181 | grep imok || exit 1"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 20
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  kafka:
    image: confluentinc/cp-kafka:6.2.0
    container_name: kafka
    hostname: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9093:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server kafka:9092 --list || exit 1"]
      interval: 30s
      timeout: 20s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

volumes:
  db_data:
  zk_data:
  zk_logs:
  redis_data:
  kafka_data:

networks:
  app-network:
    driver: bridge